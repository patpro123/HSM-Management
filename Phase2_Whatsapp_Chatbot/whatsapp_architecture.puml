@startuml whatsapp_architecture
!define RECTANGLE class

skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle

title WhatsApp Chatbot - System Architecture

' External Actors
actor "Teachers" as teacher #lightblue
actor "Students/Parents" as student #lightgreen
actor "Admin" as admin #lightyellow

package "WhatsApp Platform" {
    [WhatsApp Business\nCloud API] as whatsapp_api #FF9999
}

package "Bot Service Layer" {
    [Webhook Handler] as webhook #FFB366
    [Message Router] as router #FFB366
    [Session Manager] as session #FFB366
    [NLP Engine\n(OpenAI GPT-4)] as nlp #66B3FF
    
    package "Business Logic Handlers" {
        [Attendance Handler] as attendance_handler #99FF99
        [Schedule Handler] as schedule_handler #99FF99
        [Payment Handler] as payment_handler #99FF99
        [Enrollment Handler] as enrollment_handler #99FF99
        [Leave Handler] as leave_handler #99FF99
        [Broadcast Handler] as broadcast_handler #99FF99
    }
    
    [Response Generator] as response #FFB366
}

package "Data Layer" {
    database "PostgreSQL\n(Neon)" as postgres #CC99FF
    database "Redis\n(Upstash)" as redis #FFCC99
}

package "Backend Services" {
    [Backend API\n(Node.js)] as backend_api #FF99CC
    [Payment Gateway\n(Razorpay)] as payment #FFD700
}

package "Admin Dashboard" {
    [Admin UI\n(React)] as admin_ui #99CCFF
}

' Connections
teacher --> whatsapp_api : WhatsApp\nMessages
student --> whatsapp_api
admin --> admin_ui : Web Interface

whatsapp_api --> webhook : HTTPS\nWebhook
webhook --> router : Parse\nMessage
router --> session : Get/Update\nSession
session --> redis : Store/Retrieve

router --> nlp : Detect\nIntent
nlp --> router : Intent &\nEntities

router --> attendance_handler
router --> schedule_handler
router --> payment_handler
router --> enrollment_handler
router --> leave_handler
router --> broadcast_handler

attendance_handler --> backend_api : API Calls
schedule_handler --> backend_api
payment_handler --> backend_api
payment_handler --> payment : Generate\nPayment Link
enrollment_handler --> backend_api
leave_handler --> backend_api
broadcast_handler --> backend_api

attendance_handler --> postgres : Read/Write
schedule_handler --> postgres
payment_handler --> postgres
enrollment_handler --> postgres
leave_handler --> postgres
broadcast_handler --> postgres

attendance_handler --> response
schedule_handler --> response
payment_handler --> response
enrollment_handler --> response
leave_handler --> response
broadcast_handler --> response

response --> whatsapp_api : Send\nMessage

admin_ui --> backend_api : REST API
backend_api --> whatsapp_api : Broadcast\nMessages

backend_api --> postgres : Database\nOperations

note right of nlp
  Uses GPT-4 Turbo for:
  - Intent classification
  - Entity extraction
  - Context understanding
  - Response generation
end note

note right of redis
  Stores:
  - Session state
  - Conversation context
  - Rate limiting data
  - Temporary cache
end note

note right of postgres
  Tables:
  - whatsapp_sessions
  - whatsapp_messages
  - whatsapp_subscriptions
  - attendance_drafts
  - (existing tables)
end note

@enduml
